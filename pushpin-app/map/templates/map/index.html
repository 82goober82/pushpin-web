<!DOCTYPE HTML>
{% load staticfiles %}
<html>
<head>
<title>Pushpin - Map</title>
<meta charset="UTF-8">
<script src="http://maps.google.com/maps/api/js?sensor=false" charset="utf-8"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="{% static "js/timeline.js" %}" charset="utf-8"></script>
<script type="text/javascript">

var map;
var markers = [];
var rawData = {{ pushpins|safe }};
var cleanData = [];

rawData.forEach( function(datum) {
    cleanData.push(datum.fields);
    });

// initializes the map interface
function showMap() {
    var lat = {{ location.latitude }};
    var lon = {{ location.longitude }};
    var rad = {{ location.radius }};
    var coords = new google.maps.LatLng(lat,lon);
    var mapOptions = {
        zoom: 15,
        center: coords,
        disableDefaultUI: true,
        mapTypeControl: true,
        mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
            position: google.maps.ControlPosition.RIGHT_TOP
        },
        panControl: true,
        panControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        },
        streetViewControl: true,
        streetViewControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        },
        zoomControl: true,
        zoomControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        }
    };
    map = new google.maps.Map(document.getElementById("map"), mapOptions);
    var populationOptions = {
        strokeColor: "gray",
        strokeOpacity: 0.8,
        strokeWeight: 1,
        fillColor: "gray",
        fillOpacity: 0.1,
        map: map,
        center: coords,
        radius: rad * 1000
    };
    var cityCircle = new google.maps.Circle(populationOptions);

    function add_marker(opts, place, source) {
        var marker = new google.maps.Marker(opts);
        var infowindow = new google.maps.InfoWindow({
            autoScroll: false,
            content: place.details
        });
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map,marker);
        });
        /*if (typeof source !== 'undefined') {
            window[source].push(marker);
            if(!(window.data.hasOwnProperty(source))) { window.data[source] = []; }
            window.data[source].push(place.details.match(/<span class='time'>(.*?)<\/span>/i)[1]); // I had 99 problems, so I used regular expressions
            window.sources.push(source);
        }*/
    }

    add_marker({position:coords,title:"Epicenter",icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png",map:map},{details:"Epicenter:<br />" + lat + "," + lon + "<br />Radius: " + rad + "km"});

    cleanData.forEach(function(pin) {
      add_marker({position: new google.maps.LatLng(pin.latitude, pin.longitude) , title: pin.screen_name, icon: pin.thumb_url, map:map}, {details: pin.message}, pin.source);
      // TODO fill out details in to HTML template
    });

  /*
     example input here:
     add_marker(
     {position: new google.maps.LatLng(42.297276,-71.26462),title:"preschang",icon:"http://maps.google.com/mapfiles/ms/icons/orange-dot.png",map:map},
     {details:"<table><tr><td class='prof_cell'><a href='https://farm4.staticflickr.com/3929/15391622816_6e1b496075.jpg' target='_blank'><img class='prof_img rounded' src='https://farm4.staticflickr.com/3929/15391622816_6e1b496075_t.jpg' /></a></td><td class='data_cell'>[<a href='http://flickr.com/photos/99579729@N06' target='_blank'>preschang</a>] Add #Babson College this week as a member of the #Goldman Sachs 10k small business program. Learning how to be a better #business man!<br /><span class='time'>2014-10-01 12:05:41</span></td></tr></table>"},
     "flickr"
     );
  */

    TIMELINE.createTimeline(window.data); // creates the d3.js timeline
}

// sets the map on all markers in the array
function setAllMap(map, source) {
    for (var i = 0; i < window[source].length; i++) {
        window[source][i].setMap(map);
    }
}

// removes the markers from the map, but keeps them in the array
function clearMarkers(source) {
    setAllMap(null, source);
}

// shows any markers currently in the array
function showMarkers(source) {
    setAllMap(map, source);
}

function toggleMarkers(source) {
    if(document.getElementById(source).checked) {
        showMarkers(source);
        TIMELINE.addActive(source);
    } else {
        clearMarkers(source);
        TIMELINE.removeActive(source);
    }
}

google.maps.event.addDomListener(window, 'load', showMap);

</script>
<style type="text/css">
html {
    height: 100%%
}
body {
    font-family: Verdana, Geneva, sans-serif;
    height: 100%%;
    margin: 0;
    padding: 0
}
td {
    padding: 5px
}
.map {
    width: 100%%;
    height: 80%%;
    -webkit-border-radius: 0px;
    -moz-border-radius: 0px;
    border-radius: 0px;
}
#timeline {
  width: 100%%;
  height: 20%%;
  font: 12px sans-serif;
}
.axis path {
  fill: none;
}
.axis line {
  opacity: .1;
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.prof_cell {
    text-align: center;
    width: 57px; /*.prof_img[50px width + (1px border x 2 sides) + 5px margin]*/
}
.data_cell {
    width: 400px;
}
.prof_img {
    width: 50px;
    height: 50px;
    border: 1px solid black;
    margin: 0 0 0 5px;
}
.time {
    font-size: .75em;
}
.rounded {
    -webkit-border-radius: 10px;
    -moz-border-radius: 10px;
    border-radius: 10px;
}
.shaded {
    border: 1px solid orange;
    -webkit-box-shadow: 3px 3px 3px gray;
    -moz-box-shadow: 3px 3px 3px gray;
    box-shadow: 3px 3px 3px gray;
}
.nav {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 99;
    padding: 10px;
    color: white;
    border: 2px solid orange;
    /* Fallback for web browsers that doesn't support RGBa */
    background: rgb(0, 0, 0);
    /* RGBa opacity */
    background: rgba(0, 0, 0, 0.6);
}
input[type=checkbox] {
    vertical-align: middle;
    position: relative;
    bottom: 1px;
}
</style>
</head>
<body>
    <div id="nav" class="nav rounded shaded">
        <div id="filter">
          {% for source in sources %}
            <input type="checkbox" id="{{ source }}" onchange="toggleMarkers('{{ source }}');" checked="checked"/>{{ source }}<br />
          {% endfor %}
<!-- example input here:
<input type="checkbox" id="flickr" onchange="toggleMarkers('flickr');" checked="checked"/>Flickr<br />
     options include: flickr, picasa, shodan, twitter, youtube
-->
        </div>
        <div id="summary"></div>
    </div>
    <div class="map" id="map"></div>
    <div id="timeline"></div>
</body>
</html>
