<!DOCTYPE HTML>
<html>
<head>
<title>Pushpin - Map</title>
<meta charset="UTF-8">
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script type="text/javascript">

var map;
%s // initialize empty arrays here, for example: var flickr = [];
   // options include: flickr, picasa, shodan, twitter, youtube
var markers = [];
var sources = [];
var data = {};

// initializes the map interface
function showMap() {
    var lat = %s;
    var lon = %s;
    var rad = %s;
    var coords = new google.maps.LatLng(lat,lon);
    var mapOptions = {
        zoom: 15,
        center: coords,
        disableDefaultUI: true,
        mapTypeControl: true,
        mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
            position: google.maps.ControlPosition.RIGHT_TOP
        },
        panControl: true,
        panControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        },
        streetViewControl: true,
        streetViewControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        },
        zoomControl: true,
        zoomControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        }
    };
    map = new google.maps.Map(document.getElementById("map"), mapOptions);
    var populationOptions = {
        strokeColor: "gray",
        strokeOpacity: 0.8,
        strokeWeight: 1,
        fillColor: "gray",
        fillOpacity: 0.1,
        map: map,
        center: coords,
        radius: rad * 1000
    };
    var cityCircle = new google.maps.Circle(populationOptions);

    function add_marker(opts, place, source) {
        var marker = new google.maps.Marker(opts);
        var infowindow = new google.maps.InfoWindow({
            autoScroll: false,
            content: place.details
        });
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map,marker);
        });
        if (typeof source !== 'undefined') {
            window[source].push(marker);
            if(!(window.data.hasOwnProperty(source))) { window.data[source] = []; }
            window.data[source].push(place.details.match(/<span class='time'>(.*?)<\/span>/i)[1]); // I had 99 problems, so I used regular expressions
            window.sources.push(source);
        }
    }

    add_marker({position:coords,title:"Epicenter",icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png",map:map},{details:"Epicenter:<br />" + lat + "," + lon + "<br />Radius: " + rad + "km"});
%s

  /*
     example input here:
     add_marker(
     {position: new google.maps.LatLng(42.297276,-71.26462),title:"preschang",icon:"http://maps.google.com/mapfiles/ms/icons/orange-dot.png",map:map},
     {details:"<table><tr><td class='prof_cell'><a href='https://farm4.staticflickr.com/3929/15391622816_6e1b496075.jpg' target='_blank'><img class='prof_img rounded' src='https://farm4.staticflickr.com/3929/15391622816_6e1b496075_t.jpg' /></a></td><td class='data_cell'>[<a href='http://flickr.com/photos/99579729@N06' target='_blank'>preschang</a>] Add #Babson College this week as a member of the #Goldman Sachs 10k small business program. Learning how to be a better #business man!<br /><span class='time'>2014-10-01 12:05:41</span></td></tr></table>"},
     "flickr"
     );
  */

    TIMELINE.createTimeline(window.data); // creates the d3.js timeline
}

// sets the map on all markers in the array
function setAllMap(map, source) {
    for (var i = 0; i < window[source].length; i++) {
        window[source][i].setMap(map);
    }
}

// removes the markers from the map, but keeps them in the array
function clearMarkers(source) {
    setAllMap(null, source);
}

// shows any markers currently in the array
function showMarkers(source) {
    setAllMap(map, source);
}

function toggleMarkers(source) {
    if(document.getElementById(source).checked) {
        showMarkers(source);
        TIMELINE.addActive(source);
    } else {
        clearMarkers(source);
        TIMELINE.removeActive(source);
    }
}

var TIMELINE = {

  elementId: "#timeline",

  minTime: null,
  maxTime: null,
  numBins: 80,
  binSize: null,

  data: null, // note: this is always CLEANED data
  active: null, // array of strings describing the active data sources

  createTimeline: function(data) {
    if (TIMELINE.active == null) {
      // if the list of active sources hasn't been initialized, do so
      TIMELINE.active = d3.keys(data);
      TIMELINE.active.push('total');
    }

    var clean = TIMELINE.cleanData(data);
    TIMELINE.render(clean);
  },

  update: function() {
    TIMELINE.clear();
    TIMELINE.render(TIMELINE.data);
  },

  clear: function() {
    var container = document.getElementById(TIMELINE.elementId.substr(1));
    while(container.firstChild) {
      container.removeChild(container.firstChild);
    }
  },

  addActive: function(source) {
    if(TIMELINE.active.indexOf(source) == -1) {
      TIMELINE.active.push(source);
      TIMELINE.update();
    }
  },

  removeActive: function(source) {
    TIMELINE.active = TIMELINE.active.filter(function(elem) {
        if(elem === source){ return false; }
        else { return true; }
        });
    TIMELINE.update();
  },

  cleanData:function (timelineData) {

    //var active = d3.keys(timelineData);
    //TIMELINE.active = active;

    var dateFormat = d3.time.format("%%Y-%%m-%%d %%H:%%M:%%S");

    d3.entries(timelineData).forEach(function(entry) {
      timelineData[entry.key] = entry.value.map(function(time) { return dateFormat.parse(time); });
      // format all of the dates as date objects instead of strings and remove anything older than 5 years
    });

    d3.entries(timelineData).forEach(function(entry) {
      timelineData[entry.key] = entry.value.filter(function(time) { console.log(time); if(new Date().getFullYear() - time.getFullYear() < 5) { return true; } return false; });
      // filter out any pins older than 4ish years
    });

    var allData = d3.merge(d3.values(timelineData)); // all of the retrieved objects in one giant var

    //var weird = allData.filter(function(item) { if(item.getFullYear() < 1995) { return true; } return false; });
    //console.log(weird);

    TIMELINE.minTime = d3.min(allData).getTime();
    TIMELINE.maxTime = d3.max(allData).getTime();

    TIMELINE.binSize = (TIMELINE.maxTime - TIMELINE.minTime) / TIMELINE.numBins;

    // Initialize series structure.
    var series = {};
    TIMELINE.active.map(function(key) {
      series[key] = [];
    });

    // Set up empty bins.
    for(var i=0; i< TIMELINE.numBins+1; i++) {
      TIMELINE.active.map(function(key) {
        series[key].push({time:new Date(TIMELINE.minTime+(i*TIMELINE.binSize)), count:0});
      });
    }

    // Bin pins.
    d3.entries(timelineData).forEach(function(entry) {
      entry.value.map(function(pin) {
        var source = entry.key;
        var time = pin.getTime();
        var bindex = Math.floor((time-TIMELINE.minTime)/TIMELINE.binSize); // the index of the bin this pin goes in (for great win)

        if (0 <= bindex && bindex <= TIMELINE.numBins) {
          series['total'][bindex].count += 1;
          if (TIMELINE.active.indexOf(source) != -1) {
            series[source][bindex].count += 1;
          }
        }
      });
    });

    // Add empty first and last bins to each series -> line needs to start and end on x axis so fills work
    TIMELINE.active.map(function(key) {
      series[key] = [{time: new Date(TIMELINE.minTime-TIMELINE.binSize), count:0}].concat(series[key]); // empty first bin
      series[key].push({time:new Date(TIMELINE.minTime+((TIMELINE.numBins+1)*TIMELINE.binSize)), count:0}); // empty last bin
    });

    // Reformat for d3.
    // http://www.delimited.io/blog/2014/3/3/creating-multi-series-charts-in-d3-lines-bars-area-and-streamgraphs
    var res = [];
    for (key in series) {
      res.push({label:key, values:series[key]});
    }
    TIMELINE.data = res;
    return res;
  },


  render: function(timelineData) {

    // first: filter the data so we're only rendering the active set
    timelineData = timelineData.filter( function(item) {
      if(TIMELINE.active.indexOf(item.label) != -1) {
        return true;
      }
      return false;
    });

    // then find what we're putting this chart into, and get sizes
    var container = d3.select(TIMELINE.elementId);
    TIMELINE.width = container.node().offsetWidth;
    TIMELINE.height = container.node().offsetHeight;

    // add margins
    var margin = {"top":10, "right":30, "bottom":30, "left":60};
    var width = TIMELINE.width - margin.left - margin.right;
    var height = TIMELINE.height - margin.top - margin.bottom; // this handles margins for us

    var x = d3.time.scale()
                   .range([0, width])
                   .domain([TIMELINE.minTime - TIMELINE.binSize, TIMELINE.maxTime + TIMELINE.binSize]);

    var y = d3.scale.linear()
                    .domain([0, d3.max(timelineData[timelineData.length-1].values, function(d){ return d.count; })])
                    .range([height, 0]);

    var xAxis = d3.svg.axis()
                      .scale(x)
                      .orient("bottom")
                      .tickSize(-height)
                      .tickPadding(6);

    var yAxis = d3.svg.axis()
                      .scale(y)
                      .orient('left')
                      .ticks(3)
                      .tickSize(-width)
                      .tickFormat(d3.format("d"));

    var all_styles = {'flickr':{color: '#FF9900', width: '1px', fillOpacity: '0.2'},
                      'picasa':{ color: '#7E55FC', width: '1px', fillOpacity: '0.2'},
                      'shodan':{ color: '#FCF357', width: '1px', fillOpacity: '0.2'},
                      'twitter':{ color: '#5781FC', width: '1px', fillOpacity: '0.2'},
                      'youtube':{ color: '#FC6355', width: '1px', fillOpacity: '0.2'},
                      'total':{ color: 'Black', width: '1px', fillOpacity: '0.2'}};

    var active_styles = TIMELINE.active.map( function(item) { return all_styles[item];  } );

    var style = d3.scale.ordinal()
                        .range(active_styles)
                        .domain(TIMELINE.active);

    var svg = container.append("svg")
                       .attr("width", width+margin.left+margin.right)
                       .attr("height", height+margin.top+margin.bottom)
                     .append("g")
                       .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var line = d3.svg.line()
                     .x(function(d) { return x(d.time); })
                     .y(function(d) { return y(d.count); })
                     .interpolate("basis");

    var series = svg.selectAll(".series")
                      .data(timelineData)
                    .enter().append("g")
                      .attr("class","series");

    series.append("path")
          .attr("class","line")
          .attr("d", function(d) { return line(d.values); })
          .style("stroke", function (d) { return style(d.label).color; })
          .style('stroke-width', function (d) { return style(d.label).width; })
          .style('fill', function (d) { return style(d.label).color; })
          .style('fill-opacity', function (d) { return style(d.label).fillOpacity; });

    svg.append("g")
       .attr("class", "x axis")
       .attr("transform", "translate(0," + height + ")")
       .call(xAxis);

    svg.append("g")
       .attr("class", "y axis")
       .call(yAxis)
       .append("text")
       .attr("transform","rotate(-90)")
       .attr("y", -90)
       .attr("x", 0)
       .attr("dy", ".71em")
       .style("text-anchor","end")
       .text("Pins");

  },
};

google.maps.event.addDomListener(window, 'load', showMap);

</script>
<style type="text/css">
html {
    height: 100%%
}
body {
    font-family: Verdana, Geneva, sans-serif;
    height: 100%%;
    margin: 0;
    padding: 0
}
td {
    padding: 5px
}
.map {
    width: 100%%;
    height: 80%%;
    -webkit-border-radius: 0px;
    -moz-border-radius: 0px;
    border-radius: 0px;
}
#timeline {
  width: 100%%;
  height: 20%%;
  font: 12px sans-serif;
}
.axis path {
  fill: none;
}
.axis line {
  opacity: .1;
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.prof_cell {
    text-align: center;
    width: 57px; /*.prof_img[50px width + (1px border x 2 sides) + 5px margin]*/
}
.data_cell {
    width: 400px;
}
.prof_img {
    width: 50px;
    height: 50px;
    border: 1px solid black;
    margin: 0 0 0 5px;
}
.time {
    font-size: .75em;
}
.rounded {
    -webkit-border-radius: 10px;
    -moz-border-radius: 10px;
    border-radius: 10px;
}
.shaded {
    border: 1px solid orange;
    -webkit-box-shadow: 3px 3px 3px gray;
    -moz-box-shadow: 3px 3px 3px gray;
    box-shadow: 3px 3px 3px gray;
}
.nav {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 99;
    padding: 10px;
    color: white;
    border: 2px solid orange;
    /* Fallback for web browsers that doesn't support RGBa */
    background: rgb(0, 0, 0);
    /* RGBa opacity */
    background: rgba(0, 0, 0, 0.6);
}
input[type=checkbox] {
    vertical-align: middle;
    position: relative;
    bottom: 1px;
}
</style>
</head>
<body>
    <div id="nav" class="nav rounded shaded">
        <div id="filter">
%s
<!-- example input here:
<input type="checkbox" id="flickr" onchange="toggleMarkers('flickr');" checked="checked"/>Flickr<br />
     options include: flickr, picasa, shodan, twitter, youtube
-->
        </div>
        <div id="summary"></div>
    </div>
    <div class="map" id="map"></div>
    <div id="timeline"></div>
</body>
</html>
